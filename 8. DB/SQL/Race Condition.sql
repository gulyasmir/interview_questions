function updateBalance(id, amount) {
    q('BEGIN')
    
    let balance = q('SELECT balance FROM user_balance WHERE user_id = :user_id', [id])
    
    if (balance > 0) {
        balance += amount
    }

    q('UPDATE user_balance SET balance = :balance WHERE user_id = :user_id', [balance, user_id])
    
    q('COMMIT')
}

/*
 –∏–∑–Ω–∞—á–∞–ª—å–Ω–æ 1000 —Ä
–ø–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å  +500
–≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å  -300
–¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –ø—Ä–∏—à–ª–∏ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –∏ –≤–æ–∑–Ω–∏–∫–ª–æ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏.
–∫–∞–∫ –∏—Å–ø—Ä–∞–≤–∏—Ç—å?*/
/*
–í  –∫–æ–¥–µ –≤–æ–∑–Ω–∏–∫–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≥–æ–Ω–∫–∏, —Ç–∞–∫ –∫–∞–∫ –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±–∞–ª–∞–Ω—Å, –∑–∞—Ç–µ–º –æ–±–∞ –æ–±–Ω–æ–≤—è—Ç –µ–≥–æ, –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—è –¥—Ä—É–≥ –¥—Ä—É–≥–∞.
–†–µ—à–µ–Ω–∏–µ: 
1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ–π –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ (FOR UPDATE)
2. –í—ã–ø–æ–ª–Ω–∏—Ç—å —Ç –æ–ª—å–∫–æ UPDATE
–î–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –≥–æ–Ω–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SELECT ... FOR UPDATE, –∫–æ—Ç–æ—Ä—ã–π –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É, –ø–æ–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è –Ω–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è. –¢–∞–∫–∏–º –æ–±—Ä–∞–∑–æ–º, –≤—Ç–æ—Ä–æ–π –∑–∞–ø—Ä–æ—Å –±—É–¥–µ—Ç –∂–¥–∞—Ç—å, –ø–æ–∫–∞ –ø–µ—Ä–≤—ã–π –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è.
–ö–æ–≥–¥–∞ –Ω—É–∂–µ–Ω FOR UPDATE?
–ï—Å–ª–∏ –≤—ã —Å–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–π—Ç–µ –±–∞–ª–∞–Ω—Å, –∞ –∑–∞—Ç–µ–º –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ UPDATE:
–ù–æ —ç—Ç–æ —Ö—É–∂–µ, —á–µ–º –ø—Ä–æ—Å—Ç–æ UPDATE balance = balance + amount, –ø–æ—Ç–æ–º—É —á—Ç–æ –¥–µ–ª–∞–µ—Ç –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ.
*/

function updateBalance(id, amount) {
    q('BEGIN') // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
    
    -- –ë–ª–æ–∫–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∂–¥–∞–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —ç—Ç–æ–π
    let balance = q('SELECT balance FROM user_balance WHERE user_id = :user_id FOR UPDATE', [id])

    -- –ò–∑–º–µ–Ω—è–µ–º –±–∞–ª–∞–Ω—Å
    balance += amount

    -- –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –≤ –ë–î
    q('UPDATE user_balance SET balance = :balance WHERE user_id = :user_id', [balance, id])

    q('COMMIT') // –§–∏–∫—Å–∏—Ä—É–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
}

/* –≤ –¥–∞–Ω–Ω–æ–º —Å–ª—É—á–∞–µ FOR UPDATE –Ω–µ –Ω—É–∂–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –≤—ã –Ω–µ —á–∏—Ç–∞–µ—Ç–µ –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º, –∞ —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç–µ –∞—Ç–æ–º–∞—Ä–Ω—É—é –æ–ø–µ—Ä–∞—Ü–∏—é */
function updateBalance(id, amount) {
    q('BEGIN')

    q('UPDATE user_balance SET balance = balance + :amount WHERE user_id = :user_id', [amount, id])

    q('COMMIT')
}

function updateBalance(id, amount) {
    try {
        q('BEGIN')

        q('UPDATE user_balance SET balance = balance + :amount WHERE user_id = :user_id', [amount, id])

        q('COMMIT')
    } catch (error) {
        q('ROLLBACK') // –û—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –ø—Ä–∏ –æ—à–∏–±–∫–µ
        throw error
    }
}

/*
FOR UPDATE –Ω—É–∂–µ–Ω, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å SELECT –ø–µ—Ä–µ–¥ UPDATE
üîπ –ü—Ä–æ—Å—Ç–æ–π UPDATE balance = balance + amount —É–∂–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω

–ü–æ—á–µ–º—É FOR UPDATE –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è?
–í—ã –Ω–µ —á–∏—Ç–∞–µ—Ç–µ –±–∞–ª–∞–Ω—Å –ø–µ—Ä–µ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º

–ï—Å–ª–∏ –±—ã —Å–Ω–∞—á–∞–ª–∞ –±—ã–ª SELECT balance FROM user_balance WHERE user_id = :user_id, —Ç–æ–≥–¥–∞ –Ω—É–∂–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ FOR UPDATE, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –≥–æ–Ω–∫–∏.
–ù–æ –∑–¥–µ—Å—å —Å—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∞—Ç–æ–º–∞—Ä–Ω—ã–π UPDATE, –∫–æ—Ç–æ—Ä—ã–π —Å–∞–º –ø–æ —Å–µ–±–µ –ø–æ—Ç–æ–∫–æ–±–µ–∑–æ–ø–∞—Å–µ–Ω.
UPDATE —É–∂–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç —Å—Ç—Ä–æ–∫—É –Ω–∞ –∑–∞–ø–∏—Å—å

–í SQL, UPDATE –Ω–∞–∫–ª–∞–¥—ã–≤–∞–µ—Ç —ç–∫—Å–∫–ª—é–∑–∏–≤–Ω—É—é –±–ª–æ–∫–∏—Ä–æ–≤–∫—É (row-level lock) –Ω–∞ –∏–∑–º–µ–Ω—è–µ–º—É—é —Å—Ç—Ä–æ–∫—É.
–î—Ä—É–≥–∏–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–ø—ã—Ç–∞—é—Ç—Å—è –æ–±–Ω–æ–≤–∏—Ç—å —Ç—É –∂–µ —Å—Ç—Ä–æ–∫—É, –±—É–¥—É—Ç –∂–¥–∞—Ç—å –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.
–ë–æ–ª–µ–µ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ, —á–µ–º SELECT ... FOR UPDATE

SELECT ... FOR UPDATE –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –¥–≤–∞ –∑–∞–ø—Ä–æ—Å–∞ (SELECT + UPDATE), —á—Ç–æ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –Ω–∞–≥—Ä—É–∑–∫—É –Ω–∞ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö.
UPDATE ... SET balance = balance + amount –¥–µ–ª–∞–µ—Ç –≤—Å—ë –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—Ä–æ—Å.
*/